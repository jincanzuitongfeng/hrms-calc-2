<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FDF6F6">
    <title>HRMS 计算器 (移动版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- 配色方案 (保持原版马卡龙色系) --- */
        :root {
            --macaron-pink: #FFB7B2;
            --macaron-purple: #C7CEEA;
            --macaron-purple-strong: #9fa8da;
            --bg-color: #FDF6F6;
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #4A5568;
            -webkit-tap-highlight-color: transparent;
        }

        /* 移动端全屏，桌面端卡片 */
        .app-container {
            background: rgba(255, 255, 255, 0.98);
            transition: all 0.3s ease;
        }

        /* 桌面端样式覆盖 */
        @media (min-width: 768px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 2rem;
            }
            .app-container {
                border-radius: 24px;
                box-shadow: 0 20px 40px rgba(199, 206, 234, 0.4);
                max-width: 680px;
                width: 100%;
                border: 2px solid #fff;
                min-height: auto;
            }
        }

        /* 输入框优化 */
        .macaron-input {
            border: 2px solid var(--macaron-purple);
            border-radius: 16px;
            padding: 14px;
            padding-right: 40px; /* 为清除按钮留位 */
            transition: all 0.3s ease;
            width: 100%;
            outline: none;
            color: #4A5568;
            background-color: #FAFAFA;
            /* iOS防止缩放的关键设置 */
            font-size: 18px !important; 
        }

        .macaron-input:focus {
            border-color: var(--macaron-pink);
            background-color: #FFF;
            box-shadow: 0 0 0 4px rgba(255, 183, 178, 0.15);
        }

        /* 清除按钮 */
        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #CBD5E0;
            cursor: pointer;
            padding: 8px;
            display: none;
        }
        .macaron-input:not(:placeholder-shown) + .clear-btn {
            display: block;
        }

        /* 模式按钮 */
        .mode-btn {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #718096;
            padding: 14px;
            border-radius: 16px;
            font-weight: 600;
            position: relative;
            touch-action: manipulation; /* 优化点击响应 */
        }
        
        .mode-btn.active {
            background: var(--macaron-purple-strong);
            border-color: var(--macaron-purple-strong);
            color: white;
            box-shadow: 0 8px 20px rgba(159, 168, 218, 0.4);
            transform: translateY(-1px);
        }

        #btnNeg.active { 
            background: #FFAB91; 
            border-color: #FFAB91; 
            box-shadow: 0 8px 20px rgba(255, 171, 145, 0.4); 
        }

        /* 表格优化 */
        .result-table th {
            background-color: #F7FAFC;
            color: #718096;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 10px 8px;
            border-bottom: 2px solid #EDF2F7;
        }
        
        .result-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #F7FAFC;
            font-size: 0.95rem;
        }

        /* 紧凑模式：小屏幕隐藏加合名称，只显示公式 */
        @media (max-width: 360px) {
            .col-name { display: none; }
        }

        .badge {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-right: 4px;
            font-weight: bold;
            vertical-align: middle;
        }
        .badge-pos { background-color: #FFDAC1; color: #D97706; }
        .badge-neg { background-color: #C7CEEA; color: #4C51BF; }

        /* 动画 */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* 安全区适配 (iPhone X+) */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="safe-pb">

    <div class="app-container min-h-screen md:min-h-0 flex flex-col p-5">
        <div class="mb-6 mt-2 md:mt-0 text-center">
            <h1 class="text-2xl font-bold text-gray-700 tracking-tight">HRMS 计算器</h1>
            <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">High Resolution Mass Spec</p>
        </div>

        <div class="mb-6 flex-none">
            <div class="flex justify-between items-center mb-2 px-1">
                <label class="text-sm font-bold text-gray-600">分子式</label>
                <div class="flex items-center bg-gray-100 rounded-lg px-2 py-1">
                    <span class="text-xs text-gray-400 mr-2">小数位</span>
                    <select id="decimalSelect" class="text-sm bg-transparent font-medium text-gray-600 outline-none" onchange="if(document.getElementById('resultContainer').style.opacity === '1') calculate()">
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            
            <div class="relative group">
                <input type="text" id="formulaInput" 
                       placeholder="如: C6H12O6" 
                       class="macaron-input font-mono uppercase tracking-wider" 
                       enterkeyhint="search"
                       onkeydown="handleKey(event)"
                       autocomplete="off">
                <div class="clear-btn" onclick="clearInput()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <p id="formulaError" class="hidden text-red-500 text-xs mt-2 px-1 font-medium flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                格式错误 (示例: C23H30N4O5)
            </p>
        </div>

        <div class="mb-6 flex-none">
            <div class="grid grid-cols-2 gap-4">
                <button class="mode-btn active flex flex-col items-center justify-center gap-1" onclick="setMode('pos')" id="btnPos">
                    <span class="text-base font-bold">POS (+)</span>
                    <span class="text-[10px] opacity-60 font-normal">正离子模式</span>
                </button>
                <button class="mode-btn flex flex-col items-center justify-center gap-1" onclick="setMode('neg')" id="btnNeg">
                    <span class="text-base font-bold">NEG (-)</span>
                    <span class="text-[10px] opacity-60 font-normal">负离子模式</span>
                </button>
            </div>
        </div>

        <div id="resultContainer" class="hidden flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-end mb-3 px-1 flex-none">
                <div>
                    <span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">Neutral Mass</span>
                    <div class="text-2xl font-bold text-gray-700 font-mono leading-none mt-1" id="neutralMassDisplay">--</div>
                </div>
                <button onclick="copyResults()" class="active:bg-gray-100 p-2 -mr-2 rounded-lg text-xs text-blue-500 font-medium transition-colors flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    复制
                </button>
            </div>

            <div class="overflow-y-auto flex-1 rounded-xl border border-gray-100 bg-white shadow-sm scroll-smooth" style="max-height: 40vh;">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                        <tr>
                            <th width="35%">离子</th>
                            <th width="30%" class="col-name">类型</th>
                            <th width="35%" class="text-right pr-4">m/z</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody" class="text-gray-600 divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-auto pt-4 text-center">
             <p class="text-[10px] text-gray-300">Supported: H, C, N, O, F, Na, P, S, Cl, K, Br, I</p>
        </div>
    </div>

    <script>
        // --- 核心数据 (保持不变) ---
        const ATOMIC_MASSES = {
            'H': 1.007825032, 'C': 12.000000000, 'N': 14.003074004, 'O': 15.994914619,
            'F': 18.998403163, 'Na': 22.989769282, 'P': 30.973761998, 'S': 31.972071174,
            'Cl': 34.968852682, 'K': 38.963706486, 'Br': 78.9183376, 'I': 126.904473
        };
        const ELECTRON_MASS = 0.0005485799;

        const ADDUCTS_POS = [
            { label: "[M+H]+",     name: "Protonated",      calc: (m) => m + ATOMIC_MASSES.H - ELECTRON_MASS },
            { label: "[M+Na]+",    name: "Sodiated",        calc: (m) => m + ATOMIC_MASSES.Na - ELECTRON_MASS },
            { label: "[M+K]+",     name: "Potassiated",     calc: (m) => m + ATOMIC_MASSES.K - ELECTRON_MASS },
            { label: "[M+NH4]+",   name: "Ammonium",        calc: (m) => m + ATOMIC_MASSES.N + (4 * ATOMIC_MASSES.H) - ELECTRON_MASS },
            { label: "[M+2H]2+",   name: "Doubly Prot.",    calc: (m) => (m + 2 * ATOMIC_MASSES.H - 2 * ELECTRON_MASS) / 2 },
            { label: "[2M+H]+",    name: "Dimer + H",       calc: (m) => (2 * m) + ATOMIC_MASSES.H - ELECTRON_MASS },
            { label: "[2M+Na]+",   name: "Dimer + Na",      calc: (m) => (2 * m) + ATOMIC_MASSES.Na - ELECTRON_MASS },
            { label: "[M+H-H2O]+", name: "Loss H2O",        calc: (m) => m + ATOMIC_MASSES.H - (2*ATOMIC_MASSES.H + ATOMIC_MASSES.O) - ELECTRON_MASS },
        ];

        const ADDUCTS_NEG = [
            { label: "[M-H]-",       name: "Deprotonated",    calc: (m) => m - ATOMIC_MASSES.H + ELECTRON_MASS },
            { label: "[M+Cl]-",      name: "Chloride",        calc: (m) => m + ATOMIC_MASSES.Cl + ELECTRON_MASS },
            { label: "[M+HCOO]-",    name: "Formate",         calc: (m) => m + ATOMIC_MASSES.H + ATOMIC_MASSES.C + (2 * ATOMIC_MASSES.O) + ELECTRON_MASS },
            { label: "[M+OAc]-",     name: "Acetate",         calc: (m) => m + (2 * ATOMIC_MASSES.C) + (3 * ATOMIC_MASSES.H) + (2 * ATOMIC_MASSES.O) + ELECTRON_MASS },
            { label: "[M+Br]-",      name: "Bromide",         calc: (m) => m + ATOMIC_MASSES.Br + ELECTRON_MASS },
            { label: "[2M-H]-",      name: "Dimer - H",       calc: (m) => (2 * m) - ATOMIC_MASSES.H + ELECTRON_MASS },
            { label: "[M-2H]2-",     name: "Doubly Deprot.",  calc: (m) => (m - 2 * ATOMIC_MASSES.H + 2 * ELECTRON_MASS) / 2 },
            { label: "[M+TFA-H]-",   name: "TFA Adduct",      calc: (m) => m + (2*ATOMIC_MASSES.C + ATOMIC_MASSES.H + 3*ATOMIC_MASSES.F + 2*ATOMIC_MASSES.O) - ATOMIC_MASSES.H + ELECTRON_MASS }
        ];

        let currentMode = 'pos';

        // 页面加载完成后聚焦输入框 (可选，如果觉得键盘弹出烦人可注释掉)
        // window.onload = () => document.getElementById('formulaInput').focus();

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnPos').className = `mode-btn flex flex-col items-center justify-center gap-1 ${mode === 'pos' ? 'active' : ''}`;
            document.getElementById('btnNeg').className = `mode-btn flex flex-col items-center justify-center gap-1 ${mode === 'neg' ? 'active' : ''}`;
            
            // 如果已有输入，切换模式直接重
