<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FDF6F6">
    <title>HRMS 计算器 (手机端)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- 配色方案 --- */
        :root {
            --macaron-pink: #FFB7B2;
            --macaron-purple: #C7CEEA;
            --macaron-purple-strong: #9fa8da;
            --bg-color: #FDF6F6;
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #4A5568;
            -webkit-tap-highlight-color: transparent;
        }

        /* 移动端全屏，桌面端卡片 */
        .app-container {
            background: rgba(255, 255, 255, 0.98);
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 2rem;
            }
            .app-container {
                border-radius: 24px;
                box-shadow: 0 20px 40px rgba(199, 206, 234, 0.4);
                max-width: 680px;
                width: 100%;
                border: 2px solid #fff;
                min-height: auto;
            }
        }

        /* 输入框优化 */
        .macaron-input {
            border: 2px solid var(--macaron-purple);
            border-radius: 16px;
            padding: 14px;
            padding-right: 40px; 
            transition: all 0.3s ease;
            width: 100%;
            outline: none;
            color: #4A5568;
            background-color: #FAFAFA;
            font-size: 18px !important; /* iOS防止缩放 */
            text-transform: uppercase; /* 视觉大写 */
        }

        .macaron-input:focus {
            border-color: var(--macaron-pink);
            background-color: #FFF;
            box-shadow: 0 0 0 4px rgba(255, 183, 178, 0.15);
        }

        /* 清除按钮 */
        .clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #CBD5E0;
            cursor: pointer;
            padding: 8px;
            display: none;
            z-index: 10;
        }
        .macaron-input:not(:placeholder-shown) + .clear-btn {
            display: block;
        }

        /* 模式按钮 */
        .mode-btn {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #718096;
            padding: 12px;
            border-radius: 16px;
            font-weight: 600;
            position: relative;
            touch-action: manipulation;
        }
        
        .mode-btn.active {
            background: var(--macaron-purple-strong);
            border-color: var(--macaron-purple-strong);
            color: white;
            box-shadow: 0 4px 12px rgba(159, 168, 218, 0.4);
        }

        #btnNeg.active { 
            background: #FFAB91; 
            border-color: #FFAB91; 
            box-shadow: 0 4px 12px rgba(255, 171, 145, 0.4); 
        }

        /* 结果区域 */
        .result-table th {
            background-color: #F7FAFC;
            color: #718096;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 10px 8px;
            border-bottom: 2px solid #EDF2F7;
        }
        
        .result-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #F7FAFC;
            font-size: 0.95rem;
        }

        @media (max-width: 360px) {
            .col-name { display: none; }
        }

        .badge {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-right: 4px;
            font-weight: bold;
        }
        .badge-pos { background-color: #FFDAC1; color: #D97706; }
        .badge-neg { background-color: #C7CEEA; color: #4C51BF; }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="safe-pb">

    <div class="app-container min-h-screen md:min-h-0 flex flex-col p-5">
        <!-- 头部 -->
        <div class="mb-4 mt-2 md:mt-0 text-center">
            <h1 class="text-2xl font-bold text-gray-700 tracking-tight">HRMS 计算器</h1>
            <p class="text-xs text-gray-400 mt-1 uppercase">自动计算版</p>
        </div>

        <!-- 输入区域 -->
        <div class="mb-4 flex-none">
            <div class="flex justify-between items-center mb-2 px-1">
                <label class="text-sm font-bold text-gray-600">输入分子式</label>
                <div class="flex items-center bg-gray-100 rounded-lg px-2 py-1">
                    <span class="text-xs text-gray-400 mr-2">小数</span>
                    <!-- 默认值已改为 4 -->
                    <select id="decimalSelect" class="text-sm bg-transparent font-medium text-gray-600 outline-none" onchange="calculate()">
                        <option value="4" selected>4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            
            <div class="relative group">
                <input type="text" id="formulaInput" 
                       placeholder="如: C6H12O6" 
                       class="macaron-input font-mono tracking-wider" 
                       enterkeyhint="done"
                       oninput="handleInput(this)"
                       onkeydown="handleKey(event)"
                       autocomplete="off">
                       
                <div class="clear-btn" onclick="clearInput()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- 删除计算按钮 -->

            <p id="formulaError" class="hidden text-red-500 text-xs mt-3 px-1 font-medium flex items-center bg-red-50 p-2 rounded-lg border border-red-100">
                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <span id="errorText">格式错误</span>
            </p>
        </div>

        <!-- 模式选择 -->
        <div class="mb-4 flex-none">
            <div class="grid grid-cols-2 gap-3">
                <button class="mode-btn active flex flex-col items-center justify-center gap-1" onclick="setMode('pos')" id="btnPos">
                    <span class="text-sm font-bold">POS (+)</span>
                    <span class="text-[10px] opacity-60 font-normal">正离子</span>
                </button>
                <button class="mode-btn flex flex-col items-center justify-center gap-1" onclick="setMode('neg')" id="btnNeg">
                    <span class="text-sm font-bold">NEG (-)</span>
                    <span class="text-[10px] opacity-60 font-normal">负离子</span>
                </button>
            </div>
        </div>

        <!-- 结果区域 -->
        <div id="resultContainer" class="hidden flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-end mb-2 px-1 flex-none">
                <div>
                    <span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">Neutral Mass</span>
                    <div class="text-2xl font-bold text-gray-700 font-mono leading-none mt-1" id="neutralMassDisplay">--</div>
                </div>
                <button onclick="copyResults()" class="bg-blue-50 hover:bg-blue-100 p-2 rounded-lg text-xs text-blue-600 font-bold transition-colors flex items-center">
                    复制结果
                </button>
            </div>

            <div class="overflow-y-auto flex-1 rounded-xl border border-gray-100 bg-white shadow-sm scroll-smooth">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                        <tr>
                            <th width="35%">离子</th>
                            <th width="30%" class="col-name">类型</th>
                            <th width="35%" class="text-right pr-4">m/z</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody" class="text-gray-600 divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-auto pt-2 text-center">
             <p class="text-[10px] text-gray-300">Supported: H, C, N, O, F, Na, P, S, Cl, K, Br, I</p>
        </div>
    </div>

    <script>
        const ATOMIC_MASSES = {
            'H': 1.007825032, 'C': 12.000000000, 'N': 14.003074004, 'O': 15.994914619,
            'F': 18.998403163, 'Na': 22.989769282, 'P': 30.973761998, 'S': 31.972071174,
            'Cl': 34.968852682, 'K': 38.963706486, 'Br': 78.9183376, 'I': 126.904473
        };
        const ELECTRON_MASS = 0.0005485799;

        const ADDUCTS_POS = [
            { label: "[M+H]+",     name: "Protonated",      calc: (m) => m + ATOMIC_MASSES.H - ELECTRON_MASS },
            { label: "[M+Na]+",    name: "Sodiated",        calc: (m) => m + ATOMIC_MASSES.Na - ELECTRON_MASS },
            { label: "[M+K]+",     name: "Potassiated",     calc: (m) => m + ATOMIC_MASSES.K - ELECTRON_MASS },
            { label: "[M+NH4]+",   name: "Ammonium",        calc: (m) => m + ATOMIC_MASSES.N + (4 * ATOMIC_MASSES.H) - ELECTRON_MASS },
            { label: "[M+2H]2+",   name: "Doubly Prot.",    calc: (m) => (m + 2 * ATOMIC_MASSES.H - 2 * ELECTRON_MASS) / 2 },
            { label: "[2M+H]+",    name: "Dimer + H",       calc: (m) => (2 * m) + ATOMIC_MASSES.H - ELECTRON_MASS },
            { label: "[2M+Na]+",   name: "Dimer + Na",      calc: (m) => (2 * m) + ATOMIC_MASSES.Na - ELECTRON_MASS },
            { label: "[M+H-H2O]+", name: "Loss H2O",        calc: (m) => m + ATOMIC_MASSES.H - (2*ATOMIC_MASSES.H + ATOMIC_MASSES.O) - ELECTRON_MASS },
        ];

        const ADDUCTS_NEG = [
            { label: "[M-H]-",       name: "Deprotonated",    calc: (m) => m - ATOMIC_MASSES.H + ELECTRON_MASS },
            { label: "[M+Cl]-",      name: "Chloride",        calc: (m) => m + ATOMIC_MASSES.Cl + ELECTRON_MASS },
            { label: "[M+HCOO]-",    name: "Formate",         calc: (m) => m + ATOMIC_MASSES.H + ATOMIC_MASSES.C + (2 * ATOMIC_MASSES.O) + ELECTRON_MASS },
            { label: "[M+OAc]-",     name: "Acetate",         calc: (m) => m + (2 * ATOMIC_MASSES.C) + (3 * ATOMIC_MASSES.H) + (2 * ATOMIC_MASSES.O) + ELECTRON_MASS },
            { label: "[M+Br]-",      name: "Bromide",         calc: (m) => m + ATOMIC_MASSES.Br + ELECTRON_MASS },
            { label: "[2M-H]-",      name: "Dimer - H",       calc: (m) => (2 * m) - ATOMIC_MASSES.H + ELECTRON_MASS },
            { label: "[M-2H]2-",     name: "Doubly Deprot.",  calc: (m) => (m - 2 * ATOMIC_MASSES.H + 2 * ELECTRON_MASS) / 2 },
            { label: "[M+TFA-H]-",   name: "TFA Adduct",      calc: (m) => m + (2*ATOMIC_MASSES.C + ATOMIC_MASSES.H + 3*ATOMIC_MASSES.F + 2*ATOMIC_MASSES.O) - ATOMIC_MASSES.H + ELECTRON_MASS }
        ];

        let currentMode = 'pos';
        let debounceTimer;

        window.onload = () => {
             if(document.getElementById('formulaInput').value) calculate();
        };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnPos').className = `mode-btn flex flex-col items-center justify-center gap-1 ${mode === 'pos' ? 'active' : ''}`;
            document.getElementById('btnNeg').className = `mode-btn flex flex-col items-center justify-center gap-1 ${mode === 'neg' ? 'active' : ''}`;
            calculate(); 
        }

        function clearInput() {
            const input = document.getElementById('formulaInput');
            input.value = '';
            input.focus();
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('formulaError').classList.add('hidden');
        }

        function handleKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('formulaInput').blur();
            }
        }

        function handleInput(el) {
            el.value = el.value.toUpperCase();
            document.getElementById('formulaError').classList.add('hidden');
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if(el.value.trim().length > 0) calculate(false); 
            }, 500);
        }

        function parseFormula(formula) {
            formula = formula.trim().toUpperCase();
            
            const regex = /([A-Z][a-z]*)(\d*)/g;
            let match;
            const elements = {};
            let validLength = 0;

            while ((match = regex.exec(formula)) !== null) {
                const element = match[1];
                const count = match[2] === '' ? 1 : parseInt(match[2]);
                if (!ATOMIC_MASSES[element]) throw new Error("含有不支持的元素: " + element);
                elements[element] = (elements[element] || 0) + count;
                validLength += match[0].length;
            }
            if (validLength !== formula.length) throw new Error("格式错误，请检查输入");
            if (Object.keys(elements).length === 0) throw new Error("请输入分子式");
            return elements;
        }

        function calculate(showError = false) {
            const input = document.getElementById('formulaInput').value.trim().toUpperCase();
            const errorEl = document.getElementById('formulaError');
            const errorText = document.getElementById('errorText');
            const resultContainer = document.getElementById('resultContainer');
            const resultBody = document.getElementById('resultBody');
            const precision = parseInt(document.getElementById('decimalSelect').value);

            errorEl.classList.add('hidden');

            if (!input) {
                return;
            }

            try {
                const elements = parseFormula(input);
                
                let neutralMass = 0;
                for (let el in elements) neutralMass += ATOMIC_MASSES[el] * elements[el];
                
                document.getElementById('neutralMassDisplay').textContent = neutralMass.toFixed(precision);
                resultBody.innerHTML = '';

                const adductList = currentMode === 'pos' ? ADDUCTS_POS : ADDUCTS_NEG;
                
                adductList.forEach((adduct, index) => {
                    const mz = adduct.calc(neutralMass);
                    const row = document.createElement('tr');
                    
                    const isPrimary = (index === 0);
                    const mzColor = isPrimary ? 'text-indigo-600 font-bold' : 'text-gray-700';
                    const badgeClass = currentMode === 'pos' ? 'badge-pos' : 'badge-neg';
                    const sign = currentMode === 'pos' ? '+' : '-';
                    
                    row.innerHTML = `
                        <td>
                            <span class="badge ${badgeClass}">${sign}</span>
                            <span class="font-medium text-sm">${adduct.label}</span>
                        </td>
                        <td class="col-name text-xs text-gray-400">${adduct.name}</td>
                        <td class="${mzColor} font-mono text-base text-right pr-4">${mz.toFixed(precision)}</td>
                    `;
                    resultBody.appendChild(row);
                });

                resultContainer.classList.remove('hidden');
                resultContainer.classList.remove('animate-fade-in');
                void resultContainer.offsetWidth; 
                resultContainer.classList.add('animate-fade-in');

            } catch (err) {
                resultContainer.classList.add('hidden');
                if (input.length > 1) {
                    errorText.textContent = err.message || "格式错误";
                    errorEl.classList.remove('hidden');
                }
            }
        }

        function copyResults() {
            const resultBody = document.getElementById('resultBody');
            if(document.getElementById('resultContainer').classList.contains('hidden')) return;

            let text = `Formula: ${document.getElementById('formulaInput').value}\n`;
            text += `Neutral: ${document.getElementById('neutralMassDisplay').textContent}\n\n`;
            
            const rows = resultBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                text += `${cols[0].innerText.trim()}\t${cols[2].innerText.trim()}\n`;
            });

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert("复制成功！");
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                alert("复制成功！");
            }
        }
    </script>
</body>
</html>
